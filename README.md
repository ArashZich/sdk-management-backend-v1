# سیستم مدیریت SDK آرایش مجازی

این پروژه یک بک‌اند مبتنی بر Node.js و Express است که برای مدیریت SDK آرایش مجازی طراحی شده است. این سیستم امکانات متعددی از جمله مدیریت کاربران، پلن‌ها، محصولات، سیستم پرداخت، و SDK با قابلیت‌های پیشرفته را فراهم می‌کند.

## ویژگی‌های اصلی

- **مدیریت کاربر**: ثبت‌نام با OTP، پشتیبانی از OAuth، مدیریت پروفایل
- **مدیریت پلن**: ایجاد و مدیریت پلن‌های مختلف با امکانات متفاوت
- **مدیریت محصول**: ایجاد و مدیریت محصولات آرایشی با ویژگی‌های مختلف
- **سیستم پرداخت**: اتصال به درگاه پرداخت PayPing، کوپن تخفیف
- **SDK با توکن امن**: دسترسی محدود به دامنه‌ها، مدیریت ویژگی‌های دسترسی
- **آنالیتیکس کامل**: تحلیل استفاده از SDK بر اساس مرورگر، دستگاه و زمان
- **سیستم اطلاع‌رسانی**: اطلاع‌رسانی داخلی و پیامک برای رویدادهای مختلف
- **پنل مدیریت**: امکانات ویژه برای مدیران سیستم

## پیش‌نیازها

- Node.js 18.x
- MongoDB 6.0+
- Redis 7.0+
- یک حساب کاربری در [PayPing](https://payping.ir) برای پرداخت
- یک حساب کاربری در [کاوه‌نگار](https://kavenegar.com) برای ارسال پیامک

## نصب و راه‌اندازی

### با استفاده از Docker (توصیه شده)

1. کلون کردن مخزن:
   ```bash
   git clone https://repository-url/sdk-management-backend.git
   cd sdk-management-backend
   ```

2. ایجاد فایل `.env` بر اساس `.env.example`:
   ```bash
   cp .env.example .env
   ```

3. ویرایش فایل `.env` و تنظیم متغیرهای محیطی مورد نیاز

4. اجرا با Docker Compose:
   ```bash
   docker-compose up -d
   ```

### بدون Docker

1. کلون کردن مخزن:
   ```bash
   git clone https://repository-url/sdk-management-backend.git
   cd sdk-management-backend
   ```

2. ایجاد فایل `.env` بر اساس `.env.example`:
   ```bash
   cp .env.example .env
   ```

3. ویرایش فایل `.env` و تنظیم متغیرهای محیطی مورد نیاز

4. نصب وابستگی‌ها:
   ```bash
   npm install
   ```

5. اجرای سرور در محیط توسعه:
   ```bash
   npm run dev
   ```

6. اجرای سرور در محیط تولید:
   ```bash
   npm start
   ```

## ساختار پروژه

```
src/
├── config/           # تنظیمات برنامه
├── controllers/      # کنترلرها
├── middlewares/      # میدلورها
├── models/           # مدل‌های داده
├── routes/           # مسیرهای API
├── services/         # سرویس‌ها
├── utils/            # توابع کمکی
├── crons/            # وظایف زمان‌بندی شده
├── seeds/            # داده‌های اولیه
└── app.js            # فایل اصلی برنامه
```

## API‌های اصلی

- **احراز هویت**:
  - `POST /api/v1/auth/login/otp`: ارسال کد تایید
  - `POST /api/v1/auth/verify-otp`: تایید کد OTP و دریافت توکن
  - `POST /api/v1/auth/refresh-token`: نوسازی توکن
  - `POST /api/v1/auth/logout`: خروج

- **کاربران**:
  - `GET /api/v1/users/me`: دریافت پروفایل خود
  - `PUT /api/v1/users/me`: به‌روزرسانی پروفایل
  - `PUT /api/v1/users/me/domains`: به‌روزرسانی دامنه‌های مجاز

- **پلن‌ها**:
  - `GET /api/v1/plans/public`: دریافت پلن‌های عمومی
  - `GET /api/v1/plans`: دریافت همه پلن‌ها (ادمین)
  - `POST /api/v1/plans`: ایجاد پلن جدید (ادمین)

- **محصولات**:
  - `GET /api/v1/products/me`: دریافت محصولات کاربر جاری
  - `POST /api/v1/products`: ایجاد محصول جدید
  - `GET /api/v1/products/:productId`: دریافت محصول با شناسه

- **بسته‌ها**:
  - `GET /api/v1/packages/me`: دریافت بسته‌های کاربر جاری
  - `POST /api/v1/packages`: ایجاد بسته بدون پرداخت (ادمین)
  - `POST /api/v1/packages/:packageId/extend`: تمدید بسته (ادمین)

- **پرداخت**:
  - `POST /api/v1/payments`: ایجاد درخواست پرداخت
  - `GET /api/v1/payments/callback`: بازگشت از درگاه پرداخت
  - `GET /api/v1/payments/me`: دریافت پرداخت‌های کاربر جاری

- **کوپن**:
  - `POST /api/v1/coupons/validate`: بررسی اعتبار کوپن
  - `GET /api/v1/coupons`: دریافت همه کوپن‌ها (ادمین)
  - `POST /api/v1/coupons`: ایجاد کوپن جدید (ادمین)

- **اطلاعیه‌ها**:
  - `GET /api/v1/notifications/me`: دریافت اطلاعیه‌های کاربر جاری
  - `POST /api/v1/notifications/:notificationId/read`: علامت‌گذاری اطلاعیه به عنوان خوانده شده
  - `POST /api/v1/notifications/read-all`: علامت‌گذاری همه اطلاعیه‌ها به عنوان خوانده شده

- **SDK**:
  - `POST /api/v1/sdk/validate`: اعتبارسنجی توکن SDK
  - `GET /api/v1/sdk/products`: دریافت محصولات برای SDK
  - `GET /api/v1/sdk/products/:productUid`: دریافت محصول با UID برای SDK
  - `POST /api/v1/sdk/apply`: درخواست اعمال آرایش
  - `GET /api/v1/sdk/status`: دریافت وضعیت SDK

- **آنالیتیکس**:
  - `GET /api/v1/usage/analytics`: دریافت آنالیتیکس استفاده کاربر جاری
  - `GET /api/v1/usage/analytics/download`: دانلود آنالیتیکس استفاده کاربر جاری

## ویژگی‌های پیشرفته

### محدودیت درخواست بر اساس IP و زمان

سیستم به گونه‌ای طراحی شده که اگر کاربری با یک IP خاص در بازه زمانی 10 دقیقه، چندین درخواست به SDK ارسال کند، فقط یک درخواست از محدودیت پلن کاربر کم می‌شود. این ویژگی به کاربران اجازه می‌دهد در یک نشست، از SDK به صورت نامحدود استفاده کنند.

### پلن‌های با درخواست بی‌نهایت

امکان تعریف پلن‌هایی با تعداد درخواست نامحدود (بی‌نهایت) وجود دارد. این پلن‌ها با مقدار `-1` در فیلد `requestLimit.monthly` مشخص می‌شوند.

### آنالیتیکس استفاده

سیستم، داده‌های جامعی از نحوه استفاده کاربران از SDK را جمع‌آوری می‌کند:
- آمار مرورگرهای استفاده شده
- توزیع دستگاه‌ها (موبایل، دسکتاپ، تبلت)
- الگوهای زمانی استفاده (ساعات پرتراکم، روزهای پرتراکم)
- نرخ موفقیت درخواست‌ها

### میدلور Rate Limiter

برای جلوگیری از سوء استفاده، سیستم دارای میدلور Rate Limiter است که تعداد درخواست‌ها به API را محدود می‌کند. به صورت پیش‌فرض، هر IP می‌تواند 300 درخواست در دقیقه ارسال کند.

## وظایف زمان‌بندی شده

- **ریست شمارنده ماهانه**: در اول هر ماه، شمارنده درخواست‌های ماهانه بسته‌ها ریست می‌شود.
- **اطلاع‌رسانی انقضای بسته**: 10 روز قبل از انقضای بسته، اطلاعیه و پیامک به کاربر ارسال می‌شود.

## داده‌های اولیه

در محیط توسعه، سیستم به صورت خودکار داده‌های اولیه زیر را ایجاد می‌کند:

- **کاربران**:
  - یک کاربر ادمین با شماره تلفن 09120000000
  - یک کاربر عادی با شماره تلفن 09120000001

- **پلن‌ها**:
  - پلن پایه: 500,000 ریال، 30 روز، ویژگی‌های محدود
  - پلن استاندارد: 1,500,000 ریال، 90 روز، ویژگی‌های متوسط
  - پلن حرفه‌ای: 3,500,000 ریال، 180 روز، همه ویژگی‌ها

- **بسته‌ها**:
  - یک بسته پلن حرفه‌ای برای هر دو کاربر با اعتبار یک ساله

## مستندات API

مستندات کامل API در آدرس زیر قابل دسترسی است:
```
http://localhost:4000/api/v1/docs
```

## نکات امنیتی

- استفاده از JWT برای احراز هویت
- محدودیت دسترسی به دامنه‌های مجاز برای SDK
- بررسی مالکیت منابع (محصولات، بسته‌ها و ...)
- میدلور Rate Limiter برای جلوگیری از حملات DOS

## نیازمندی‌های سیستم

- **CPU**: حداقل 2 هسته
- **RAM**: حداقل 2GB
- **دیسک**: حداقل 10GB
- **Node.js**: نسخه 18.x
- **MongoDB**: نسخه 6.0+
- **Redis**: نسخه 7.0+

## محیط‌های اجرا

- **development**: برای توسعه محلی با داده‌های اولیه و لاگ کامل
- **test**: برای اجرای آزمون‌ها
- **production**: برای محیط تولید با بهینه‌سازی‌های لازم

## مدیریت خطا

سیستم دارای مدیریت خطای یکپارچه است که همه خطاها را به فرمت یکسان برمی‌گرداند:
```json
{
  "code": 400,
  "message": "پیام خطا"
}
```

## لایسنس

این پروژه تحت لایسنس ISC منتشر شده است.

## تماس

برای پشتیبانی یا سوالات بیشتر، لطفاً با [ایمیل پشتیبانی](mailto:support@example.com) تماس بگیرید.

---

توجه: این پروژه با Node.js 18.x سازگار است و به‌طور کامل با این نسخه تست شده است.